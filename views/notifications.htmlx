<html lang="en">
	<head>
		%{indent(BOILERPLATE,levels=2)}
		<link rel="stylesheet" href="/assets/css/noti.css" />
		<script src="/assets/js/fontawesome.js"></script>
		<script>
			let sendNotifications = Notification.permission === "granted";
			function subscribeToNotifications() {
				if (!("Notification" in window)) {
					toast("This browser does not support desktop notification", "long");
				} else if (Notification.permission === "granted") {
					sendNotifications = true;
				} else if (Notification.permission !== "denied") {
					Notification.requestPermission().then((permission) => {
						if (permission === "granted") {
							sendNotifications = true;
							location.reload();
						}
					});
				}
			}
		</script>
	</head>
	<body>
		<div class="btn-align">
			<button
				type="button"
				class="button"
				onclick="subscribeToNotifications();"
			>
				<span class="button-text">Get Water Quality Alerts!</span>
				<!-- <script>
					if (sendNotifications) $host.style.display = "none";
					document.getElementById("noti-off").style.display = "none";
				</script> -->
			</button>
		</div>
		<div class="page-text">
			<p id="noti-off">
				Click the button above to begin receiving browser notifications if a
				potential problem is detected with your water!
			</p>
			<p id="noti-on" style="display: none">
				You are currently allowing browser notifications for water quality
				alerts. Reset site permissions to sop receiving alerts!
			</p>
			<p>
				If you ever miss what a notification says, the message will be displayed
				on this screen!
			</p>
		</div>
		<h2 id="heading">Past Alerts:</h2>
		<ul id="noti-display"></ul>

		<!-- <script %{TS}>
			const eventSource = new EventSource("https://ntfy.sh/wqmp-TESTING/sse");
			const ul = $last;
			eventSource.onmessage = (e) => {
				const data = JSON.parse(event.data);
				ul.appendChild(<li>{data.message}</li>);
				if (sendNotifications) {
					const notification = new Notification(data.message);
				}
			};
		</script> -->
		<script %{TS}>
			// Retrieve past messages from localStorage and add them to the list
			const pastMessages =
				JSON.parse(localStorage.getItem("my-messages")) || [];
			pastMessages.forEach((message) => {
				const li = document.createElement("li");
				li.innerHTML = message;
				ul.appendChild(li);
			});

			// Add new messages to the list and save them to localStorage
			const eventSource = new EventSource("https://ntfy.sh/wqmp-TESTING/sse");
			const ul = $last;
			eventSource.onmessage = (e) => {
				const data = JSON.parse(event.data);
				const li = document.createElement("li");
				const message = data.message;
				const timestamp = new Date().toLocaleString();
				li.textContent = `${message} - `;
				const span = document.createElement("span");
				span.textContent = timestamp;
				li.appendChild(span);
				ul.appendChild(li);
				pastMessages.push(li.innerHTML);
				localStorage.setItem("my-messages", JSON.stringify(pastMessages));
				if (sendNotifications) {
					const notification = new Notification(message);
				}
			};
		</script>
	</body>
</html>
